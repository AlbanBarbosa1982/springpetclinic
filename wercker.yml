# docker box definition
box:
  id: openjdk
  ports:
    - "8081"

# Build definition
build:
  # The steps that will be executed on build
  steps:
    # A step that executes `spring-petclinic` command
    - script:
        name: run spring-petclinic
        code: |
          ./mvnw spring-boot:run &

# install goss
installgoss:
  steps:
    # A step that installs goss testframework` 
    - script:
      name: Install goss test framework
      code: |
        curl -fsSL https://goss.rocks/install | sh 
        
deploy:
  steps:
    - internal/docker-push:
        entrypoint: bin/goss
        cmd: 0.0.0.0 8080
        username: $USERNAME
        password: $PASSWORD
        tag: $WERCKER_GIT_COMMIT
        working-dir: $WERCKER_ROOT
        ports: "8080"
        repository: albanbarbosa/pet-clinic
        
#- internal/docker-push:
#        entrypoint: bin/get_ip
#        cmd: 0.0.0.0 8080
#        working-dir: $WERCKER_ROOT
#        tag: $WERCKER_GIT_COMMIT
#        ports: "8080"
#        username: $DOCKERHUB_USERNAME
#        password: $DOCKERHUB_PASSWORD
#        repository: $DOCKERHUB_REPO
        
# k8s
#k8s:
#  steps:
# A step that deploy to k8s 
#    - script:
#      name: deploy k8s
#      code: |
#        echo "deploy to k8s"

# deploy to k8s
deploy-to-kubernetes:
    box: openjdk
    steps:

    # https://github.com/wercker/step-bash-template
    # This Wercker step will look for files in our repo with a .template extension.
    # It will expand any environment variables in those files, then remove the
    # template extension.
      - bash-template

# The step above should leave us with a Kubernetes service and deployment yml files.
# We'll create a directory to move them to.
     - script:
       name: Prepare Kubernetes files
       code: |
         mkdir $WERCKER_OUTPUT_DIR/kubernetes
         mv kubernetes_*.yml $WERCKER_OUTPUT_DIR/kubernetes
 
     - kubectl:
       name: deploy to kubernetes
       server: $KUBERNETES_MASTER
       insecure-skip-tls-verify: true
       command: apply -f $WERCKER_OUTPUT_DIR/kubernetes/
        


